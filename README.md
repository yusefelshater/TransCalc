# ME-lite: Pavement Performance and Cost Estimation Model

## فكرة البرنامج
ME-lite هو نموذج حتمي لتقدير أداء الرصف وتكاليفه، مصمم لدمج تأثيرات معدلات البيتومين، البلاستيك، المطاط، وظروف التشغيل (درجة الحرارة، الحمل). البرنامج مكتوب بلغة Python وله واجهة رسومية (GUI) للتفاعل.

## المعادلات الرياضية المستخدمة

### 1. الحسابات الأساسية
- **الحجم (V)**: \( V = L \times W \times h \)
- **الكتلة الكلية (M_mix)**: \( M_{\text{mix}} = \rho_m \times V \)
- **كتلة البيتومين (M_bit)**: \( M_{\text{bit}} = P_b \times M_{\text{mix}} \)
- **كتلة البلاستيك (M_pl)**: \( M_{\text{pl}} = P_p \times M_{\text{bit}} \) (نسبة من كتلة البيتومين)
- **كتلة المطاط (M_rub)**: \( M_{\text{rub}} = P_r \times M_{\text{bit}} \) (نسبة من كتلة البيتومين)
- **كتلة الركام (M_agg)**: \( M_{\text{agg}} = M_{\text{mix}} - M_{\text{bit}} \)

### 2. تأثير درجة الحرارة
- **معامل التصحيح (f_T)**: \( f_T = \exp[-k \times (T - T_0)] \)
  (الثوابت: \( k = 0.025 \), \( T_0 = 25 \))

### 3. معامل المرونة (E)
- \( E = E_0 \times f_T \times \frac{1 + p \times P_p}{1 + r \times P_r} \)
  (الثوابت: \( E_0 = 3500 \), \( p = 1.8 \), \( r = 0.8 \))
- **الحدود**: \( E = \max(500, \min(15000, E)) \)

### 4. الإجهادات
- **إجهاد الشد (ε_t)**: \( \varepsilon_t = k_{\varepsilon_t} \times \frac{1}{E} \times \frac{1}{h} \)
  (الثابت: \( k_{\varepsilon_t} = 0.028 \))
- **إجهاد الضغط (ε_c)**: \( \varepsilon_c = k_{\varepsilon_c} \times \frac{1}{E} \)
  (الثابت: \( k_{\varepsilon_c} = 0.005 \))

### 5. العمر التصميمي
- **سعة التعب (N_f)**: \( N_f = k_f \times \varepsilon_t^{-m_f} \)
- **سعة التشوه (N_r)**: \( N_r = k_r \times \varepsilon_c^{-m_r} \)
- **العمر بالسنوات**: \( \text{Life} = \frac{\min(N_f, N_r)}{A} \)

### 6. التكاليف
- **تكلفة الركام**: \( \text{Cost}_{\text{agg}} = M_{\text{agg}} \times c_{\text{agg}} \)
- **تكلفة البيتومين**: \( \text{Cost}_{\text{bit}} = (M_{\text{bit}} - M_{\text{pl}} - M_{\text{rub}}) \times c_{\text{bit}} \)
- **تكلفة البلاستيك**: \( \text{Cost}_{\text{pl}} = M_{\text{pl}} \times c_{\text{pl}} \)
- **تكلفة المطاط**: \( \text{Cost}_{\text{rub}} = M_{\text{rub}} \times c_{\text{rub}} \)
- **التكلفة الإجمالية**: \( \text{Total Cost} = \sum \text{Costs} + \text{Overhead} \)

## كيفية التشغيل
1. **الواجهة الرسومية (GUI)**:
   ```bash
   python gui.py
   ```
   - تبويبات الواجهة:
     - **Inputs**: إدخال بيانات المشروع والخلطة (L, W, h, ρ, Pb, Pr...).
     - **Overheads**: اختيار نمط حساب المصاريف العامة وإدخال القيم لكل بند.
     - **Results**: عرض النتائج الرقمية والرسوم.
     - **Warnings**: جميع التحذيرات (Validation/Soft hints).
     - **Scenarios**: مقارنة Baseline من الكتالوج مع الإعدادات الحالية وعرض التوفير.

2. **سطر الأوامر للنموذج (CLI)**:
   مثال تشغيل سريع:
   ```bash
   python cli.py \
     --L 1.0 --W 3.5 --h 0.05 \
     --rho_m 2.4 --Pb 0.055 --Pp 0.05 --Pr 0.08 \
     --T 30 --A 1.0 \
     --c_agg 100 --c_bit 500 --c_pl 200 --c_rub 300 \
     --overhead 1000
   ```

3. **الاختبار التشغيلي البسيط**:
   ```bash
   python test.py
   ```

4. **خرائط المخطط (Planner Maps)**:
   - عند تشغيل التحليل الجغرافي من الواجهة، يتم حفظ خريطة تفاعلية داخل `runs/` باسم `planner_map_<timestamp>.html`.
   - طبقات الخريطة تشمل المسار، المواقع المقترحة، المرافق الموجودة، و—عند الحاجة—مرافق fallback ضمن 200 كم.

## ملفات البرنامج
- `config.py`: الثوابت الافتراضية.
- `inputs.py`: التحقق من صحة المدخلات.
- `equations.py`: المعادلات الرياضية.
- `model.py`: الدالة الرئيسية لتشغيل النموذج.
- `gui.py`: الواجهة الرسومية.
- `test.py`: اختبار تشغيلي.
- `notebook.ipynb`: مثال تفاعلي.
 - `costs.json`: كتالوج الأسعار وBaseline ونطاقات الخلط وOverheads.

### ملفات المخطط الجغرافي (Planner)
- `planner.py`: وحدة التخطيط الجغرافي التي تقوم بـ:
  - جلب مرافق ذات صلة من OpenStreetMap (OSM) مثل محطات الأسفلت، المحاجر، نقاط الطرق السريعة، مصانع الخرسانة الجاهزة، ومصادر البيتومين.
  - حساب مسافات وقيم تقييم للمواقع المقترحة على طول المسار.
  - اقتراح مواقع جديدة كل 200 كم كاملة من طول المسار، عند نقطة المنتصف 100 كم لكل مقطع كامل.
  - تطبيق منطق fallback من ملف محلي عند عدم توفر نتائج OSM، ضمن نطاق 200 كم من المسار.
- `fallback_facilities.json`: ملف اختياري يحوي مرافق احتياطية (asphalt_plants, waste_sites, rubber_recycling, rubber_production).
- `runs/`: يضم خرائط Folium الناتجة بصيغة HTML وملفات تصدير.

#### أهم الثوابت والمنطق في `planner.py`
- `SEARCH_RADIUS_M = 200000` (200 كم): النطاق المستخدم لفلترة مرافق fallback بالنسبة للمسار.
- تقسيم الطريق إلى مقاطع طول كل منها 200 كم؛ يتم اقتراح نقطة واحدة في منتصف كل مقطع كامل فقط (عند 100 كم، 300 كم، 500 كم، ...). يتم تجاهل الجزء الأخير إذا كان أقل من 200 كم.
- منطق fallback (احتياطي) ضمن 200 كم من المسار من الملف المحلي فقط، ويُفعّل بالشروط التالية:
  - `fallback_asphalt`: يظهر فقط إذا لم تُرجِع OSM أي محطات أسفلت.
  - `fallback_rubber_recycling`: يظهر فقط إذا لم تُرجِع OSM أي نقاط تدوير مطاط.
  - `fallback_waste` و `fallback_rubber_production`: لا يظهران إلا إذا لم توجد نتائج OSM لأسفلت ولا تدوير مطاط معًا.
- يتم إنشاء خريطة تفاعلية بوساطة Folium وتُحفظ داخل `runs/` باسم مثل `planner_map_<timestamp>.html`.
- يجري استخدام أوزان تقييم قابلة للضبط، من ضمنها وزن `landuse_preference` لملاءمة استعمالات الأراضي (مع كاش بسيط لتقليل مناداة Overpass)، بالإضافة إلى مؤشرات قرب الطرق السريعة ومصادر البيتومين.

## المتطلبات
- Python 3.10+ (مطلوب لميزات typing الحديثة كما في `planner.py`)
- بيئة سطح مكتب لتشغيل الواجهة الرسومية (Tkinter يأتي ضمن تثبيت Python على Windows)

### الاعتماديات (pip)
الحزم الأساسية مذكورة في `requirements.txt`:

```
customtkinter>=5.2.0
matplotlib>=3.8.0
mplcursors>=0.5.2
openpyxl>=3.1.2
requests>=2.31.0
folium>=0.15.0
moviepy>=1.0.3
Pillow>=9.0.0
arabic-reshaper>=3.0.0
python-bidi>=0.4.2
imageio-ffmpeg>=0.4.7
```

ملاحظات:
- ميزة الفيديو التمهيدي في `intro_video.py` تعتمد أيضًا على `numpy` (اختياري). إذا أردت استخدامها:
  - `pip install numpy`
- MoviePy قد يتطلب FFmpeg. الحزمة `imageio-ffmpeg` عادةً تغطي ذلك تلقائيًا، وإن لزم: ثبّت FFmpeg أو أضِف مساره للبيئة.

### خطوات التثبيت المقترحة (Windows)
```
python -m venv .venv
.venv\Scripts\activate
pip install --upgrade pip
pip install -r requirements.txt
# (اختياري لميزة الفيديو)
pip install numpy
```

## التوثيق
يتم توثيق الثوابت والمعادلات في ملف `README.md` و docstrings داخل الكود.

---

## إدخال البيانات والتحذيرات (Validation)

- __نسبة البيتومين (Pb)__: الواجهة تعرض تحذيرًا إذا خرجت عن 4%–7%، مع تمييز الحقل.
- __نسبة المطاط من البيتومين (Pr)__: تحذير إذا خرجت عن 1%–60%.
- __نسب الركام__: يتم تطبيعها تلقائيًا لتساوي 1 − Pb. يظهر تحذير في تبويب `Warnings` عند حدوث التطبيع.
- تُدمج تحذيرات الواجهة مع تحذيرات الحساب من `model.calculate_mix()`.

## لوحة Overheads

تتيح اختيار نمط الحساب وتعديل مكونات المصاريف العامة:

- __Percent Mode__: جمع نسب المكونات ثم ضربها في تكلفة المواد (materials_subtotal).
- __Per Ton Mode__: جمع القيم بالجنيه/طن ثم ضربها في إجمالي أطنان الخلطة.
- __Hybrid Mode__: الجمع بين الطريقتين.

يقرأ البرنامج نطاقات التلميح من `costs.json`، ويولّد تحذيرات ناعمة إذا تجاوزت الإجماليات هذه التلميحات.

## تبويب Scenarios (Baseline vs Scenario)

- يقارن بين الـ Baseline من `costs.json` وبين السيناريو الحالي من الواجهة.
- يعرض جدولًا يشمل:
  - Grand Total, Materials Subtotal, Overheads Total.
  - Bitumen, Aggregates, Rubber.
  - Cost per m².
- يحسب ويعرض __التوفير__ بالجنيه وكنسبة مئوية.

## التصدير ومكان الملفات

- يتم التصدير إلى صيغة JSON ودعم Excel إن توفر، داخل المجلد `runs/` باسم يحوي الطابع الزمني.
- في حال تعذر Excel، يتم الاعتماد على JSON فقط.

## مثال تشغيل سريع

1) افتح الواجهة: `python gui.py`.
2) اترك قيم Baseline أو غيّر Pb/Pr/Overheads حسب الحاجة.
3) اضغط Run Model لمشاهدة النتائج والتحذيرات.
4) انتقل إلى تبويب Scenarios واضغط Compare Now لرؤية الفروقات والتوفير.
5) استخدم زر التصدير لحفظ النتائج في `runs/`.

---

## إعدادات وتخصيصات المخطط (Planner)
- إعدادات OSM: يمكن التحكم ببعض سلوك الطلبات عبر متغيرات بيئة (اختيارية):
  - `OSM_TIMEOUT_S` (افتراضي 45)
  - `OSM_RETRIES` (افتراضي 2)
  - `OSM_BACKOFF` (سلسلة أعداد بالثواني مثل: `"1,3,6"`)
  - `OSM_VERBOSE` (1/true لعرض محاولات الاتصال)
- الأوزان: يمكن ضبط أوزان التقييم مثل `landuse_preference` من قاموس الأوزان الافتراضي داخل `planner.py`.

## حدود معروفة
- استعلامات OSM تستخدم نافذة إحداثية موسّعة ~0.5 درجة حول المسار (تقريبًا ~50–55 كم)، بينما مرافق fallback تُفلتر ضمن 200 كم من المسار من الملف المحلي.
- المواقع المقترحة تظهر واحدة لكل 200 كم كامل فقط؛ المقطع الأخير إذا كان < 200 كم لا يُنشئ موقعًا.
- الاعتماد على Overpass API قد يتأثر بالحمولة/المهلة؛ يمكن استعمال بيئة OSM أعلاه أو إعادة المحاولة لاحقًا.
