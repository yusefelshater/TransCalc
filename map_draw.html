<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>رسم المسار - Planner</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .toolbar { position: absolute; top: 10px; right: 10px; z-index: 1000; background: rgba(0,0,0,0.6); color: #fff; padding: 10px; border-radius: 6px; }
    .toolbar button { margin: 4px; }
    .note { font-size: 12px; opacity: 0.9; margin-top: 6px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="toolbar">
    <div><b>طريقة الاستخدام</b></div>
    <div>اختر أداة "Polyline" وارسم مسار الطريق، ثم اضغط "حفظ GeoJSON".</div>
    <div class="note">يمكن رسم أكثر من جزء (MultiLineString). الملف الناتج استخدمه في واجهة البرنامج عبر زر "استيراد GeoJSON".</div>
    <button id="btnExport">حفظ GeoJSON</button>
    <button id="btnClear">مسح الرسومات</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script>
    // خريطة مبدئية على مصر
    var map = L.map('map').setView([26.8, 30.8], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    var drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    // Ensure plugin loaded; otherwise show a hint
    if (!L.Control || !L.Control.Draw) {
      console.warn('Leaflet.draw لم يتم تحميله. تحقّق من الاتصال بالإنترنت أو جرّب تحديث الصفحة (Ctrl+F5).');
      var warn = L.control({position:'topright'});
      warn.onAdd = function(){
        var d = L.DomUtil.create('div', 'leaflet-control');
        d.style.background = 'rgba(255,230,150,0.95)';
        d.style.padding = '8px';
        d.style.borderRadius = '6px';
        d.style.maxWidth = '280px';
        d.innerHTML = '<b>تنبيه:</b> تعذّر تحميل أداة الرسم. من فضلك تأكد من الاتصال بالإنترنت ثم حدّث الصفحة (Ctrl+F5).';
        return d;
      };
      warn.addTo(map);
    }

    var drawControl = new L.Control.Draw({
      position: 'topleft',
      draw: {
        polygon: false,
        rectangle: false,
        circle: false,
        marker: false,
        circlemarker: false,
        polyline: { shapeOptions: { color: '#1f77b4', weight: 4 } }
      },
      edit: { featureGroup: drawnItems }
    });
    map.addControl(drawControl);

    map.on(L.Draw.Event.CREATED, function (e) {
      var layer = e.layer;
      drawnItems.addLayer(layer);
    });

    document.getElementById('btnExport').onclick = function() {
      if (drawnItems.getLayers().length === 0) { alert('من فضلك ارسم مسار أولاً'); return; }
      // إذا كان هناك مسار واحد فقط → LineString، وإلا → MultiLineString
      var geoms = [];
      drawnItems.eachLayer(function(layer) {
        if (layer instanceof L.Polyline) {
          var latlngs = layer.getLatLngs();
          // قد تكون polyline متعددة المقاطع
          function toCoords(arr) {
            return arr.map(function(p) { return [p.lng, p.lat]; });
          }
          if (Array.isArray(latlngs[0])) {
            latlngs.forEach(function(seg){ geoms.push(toCoords(seg)); });
          } else {
            geoms.push(toCoords(latlngs));
          }
        }
      });
      var gj;
      if (geoms.length === 1) {
        gj = { type: 'Feature', properties: {}, geometry: { type: 'LineString', coordinates: geoms[0] } };
      } else {
        gj = { type: 'Feature', properties: {}, geometry: { type: 'MultiLineString', coordinates: geoms } };
      }
      var blob = new Blob([JSON.stringify(gj, null, 2)], {type: 'application/json'});
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'path.geojson';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      alert('تم حفظ GeoJSON، استخدمه في البرنامج عبر زر "استيراد GeoJSON"');
    };

    document.getElementById('btnClear').onclick = function() {
      drawnItems.clearLayers();
    };
  </script>
</body>
</html>
